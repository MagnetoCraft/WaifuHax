package lol.waifuware.Modules.EXPLOITS;

import lol.waifuware.Events.OnTickEvent;
import lol.waifuware.Modules.AbstractModule;
import lol.waifuware.Modules.CATEGORY;
import lol.waifuware.Modules.Interfaces.Module;
import lol.waifuware.Settings.BooleanSetting;
import lol.waifuware.Util.ChatUtil;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.client.MinecraftClient;
import net.minecraft.client.network.ClientPlayerEntity;
import net.minecraft.client.network.PlayerListEntry;
import net.minecraft.text.Text;
import net.minecraft.world.GameMode;

import java.util.HashMap;
import java.util.Random;

@Module(name = "GamemodeDetector", key = 0, cat = CATEGORY.EXPLOIT)
public class GameModeDetector extends AbstractModule
{
    private HashMap<PlayerListEntry, GameMode> playerModMap = new HashMap<>();

    public BooleanSetting autoCallOut = new BooleanSetting("Auto Callout", false, "call out players that change gamemode", "-aco");

    String[] emoji = "☯❤❣⚜☣⁈⁉✪✰✯✭∞♾⌀♪♩♫♬⏻⚝⚧♂♀㊗㊙☮❀✿❁✵❃✾✼❉✷❋✺✹✸✴✳✶☆⯪⯫☽☀⭐★☘❄⚔⛏⚗✂⚓✎✏✒☂☔⌛⏳⌚⚐☕☎⌨✉⌂⚒⚙⚖⚰⚱✈✁✃✄♚♔".split("");

    public GameModeDetector()
    {
        super();
        addSettings(autoCallOut);

        desc[0] = "Detect when any player on the";
        desc[1] = "the server change their gamemode";
        Create();
    }

    @EventHandler
    public void onTick(OnTickEvent e)
    {
        if(MinecraftClient.getInstance().world == null) return;
        if(MinecraftClient.getInstance().player == null) return;
        if(MinecraftClient.getInstance().isInSingleplayer()) return;

        ClientPlayerEntity player = MinecraftClient.getInstance().player;

        for (PlayerListEntry pl: player.networkHandler.getPlayerList())
        {
            if(playerModMap.containsKey(pl))
            {
                if(pl.getGameMode() != playerModMap.get(pl))
                {
                    if(pl.getProfile().getName() != null)
                    {
                        ChatUtil.SendMessage(pl.getProfile().getName() + " changed their game mode from " + playerModMap.get(pl).getName() + " to " + pl.getGameMode().getName());
                        if(autoCallOut.getEnabled()){
                            int rng = new Random().nextInt(emoji.length);
                            MinecraftClient.getInstance().player.networkHandler.sendChatMessage((pl.getProfile().getName() + " changed their game mode from " + playerModMap.get(pl).getName() + " to " + pl.getGameMode().getName() + emoji[rng]));
                        }
                        playerModMap.remove(pl);
                        playerModMap.put(pl, pl.getGameMode());
                    }
                }
            }else
            {
                playerModMap.put(pl, pl.getGameMode());
            }
        }
    }

    @Override
    public String getDisplayName() {
        return name + " §c[" + (autoCallOut.getEnabled() ? "§2" : "§4") + "callout§c]";
    }
}
